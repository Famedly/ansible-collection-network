[Interface]
Address =  {{ item.ip_address | join(', ') }}
ListenPort = {{ item.port }}
PrivateKey = {{ wg_privkeys[item.iface_name] }}
{% if item.mtu is defined %}
MTU = {{ item.mtu }}
{% endif %}

{% for peer in item.peers %}
[Peer]
PublicKey = {{ hostvars[peer].wg_pubkeys[item.iface_name] }}
{% if item.psk_enabled is defined %}
PreSharedKey = {{ hostvars[peer].pre_shared_keys[item.iface_name] }}
{% endif %}
AllowedIPs = {{ hostvars[peer].wg_ifaces | selectattr('iface_name', 'equalto', item.iface_name) | map(attribute='ip_address') | first | join(', ') }}
Endpoint = {{ hostvars[peer].wg_ifaces | selectattr('iface_name', 'equalto', item.iface_name) | map(attribute='peering_ip') | first }}:{{ hostvars[peer].wg_ifaces | selectattr('iface_name', 'equalto', item.iface_name) | map(attribute='port') | first }}
{% endfor %}
